"use strict";function encodeUTF8(e){var t,n,r,a=[];for(t=0;t<e.length;t++)(n=e.charCodeAt(t))<128?a.push(n):n<2048?a.push(192+(n>>6&31),128+(63&n)):((r=55296^n)>>10==0?(n=(r<<10)+(56320^e.charCodeAt(++t))+65536,a.push(240+(n>>18&7),128+(n>>12&63))):a.push(224+(n>>12&15)),a.push(128+(n>>6&63),128+(63&n)));return a}function sha1(e){var t,n,r,a=new Uint8Array(encodeUTF8(e)),o=(a.length+8>>>6<<4)+16,e=new Uint8Array(o<<2);for(e.set(new Uint8Array(a.buffer)),e=new Uint32Array(e.buffer),r=new DataView(e.buffer),t=0;t<o;t++)e[t]=r.getUint32(t<<2);e[a.length>>2]|=128<<24-8*(3&a.length),e[o-1]=a.length<<3;var i=[],s=[function(){return u[1]&u[2]|~u[1]&u[3]},function(){return u[1]^u[2]^u[3]},function(){return u[1]&u[2]|u[1]&u[3]|u[2]&u[3]},function(){return u[1]^u[2]^u[3]}],c=function(e,t){return e<<t|e>>>32-t},p=[1518500249,1859775393,-1894007588,-899497514],u=[1732584193,-271733879,null,null,-1009589776];for(u[2]=~u[0],u[3]=~u[1],t=0;t<e.length;t+=16){var d=u.slice(0);for(n=0;n<80;n++)i[n]=n<16?e[t+n]:c(i[n-3]^i[n-8]^i[n-14]^i[n-16],1),r=c(u[0],5)+s[n/20|0]()+u[4]+i[n]+p[n/20|0]|0,u[1]=c(u[1],30),u.pop(),u.unshift(r);for(n=0;n<5;n++)u[n]=u[n]+d[n]|0}r=new DataView(new Uint32Array(u).buffer);for(var t=0;t<5;t++)u[t]=r.getUint32(t<<2);var l=Array.prototype.map.call(new Uint8Array(new Uint32Array(u).buffer),function(e){return(e<16?"0":"")+e.toString(16)}).join("");return l}function emptyFn(){}function log(){var e=slice.call(arguments);console.log(logPrefix,e[0],e[1]||"",e[2]||"")}function error(){var e=slice.call(arguments);console.error(logPrefix,e[0],e[1]||"",e[2]||"")}function UdeskSDK(e){var t=this;if(this.state={},this.props=e||{},this.apiPath="https://"+e.companyDomain+"/business_api",!e||!e.appId)return void error("参数错误: appId必须填写",e);try{state.openid=wx.getStorageSync("openid"),log("openid="+state.openid)}catch(n){}App=function(n){["onLaunch","onShow","onHide"].forEach(function(r){var a=r.replace("on","onApp"),o=t[a]||emptyFn,i=e[a]||emptyFn;t.on(n,r,function(){o.apply(t,arguments),i.apply(this,arguments)})}),globalApp(n)},Page=function(n){["onLoad","onUnload","onShow","onHide"].forEach(function(r){var a=r.replace("on","onPage"),o=t[a]||emptyFn,i=e[a]||emptyFn;t.on(n,r,function(){o.apply(t,arguments),i.apply(this,arguments)})}),globalPage(n)}}var sdkName="Udesk JS-SDK",sdkVersion="v1.0.1",sdkPlatform="weixin_mini",logPrefix="["+sdkName+" "+sdkVersion+"]",sdkInstance,globalApp=App,globalPage=Page,ArrayProto=Array.prototype,slice=ArrayProto.slice;Object.assign(UdeskSDK.prototype,{on:function(e,t,n){if(e[t]){var r=e[t];e[t]=function(e){n.call(this,e,t),r.call(this,e)}}else e[t]=function(e){n.call(this,e,t)}},onAppShow:function(){var e=this,t=this.state;wx.login({success:function(n){t.jscode=n.code,t.lazyTraces&&(t.lazyTraces.forEach(function(t){e.trace(t.type,t.data)}),t.lazyTraces.length=0)}})},getInitData:function(e){var t=this.props;e=Object.assign({success:emptyFn,fail:emptyFn},e),wx.request({url:"https://"+t.companyDomain+"/init_data",method:"GET",success:function(t){var n=t.data||{};return 1e3!==n.code?(error("initData获取失败",t),void e.fail(t)):void e.success(t)},fail:function(t){error("获取数据失败",t),e.fail(t)}})},getOpenId:function(e){var t=this.props,n=this.state;return e=Object.assign({success:emptyFn,fail:emptyFn},e),n.openid?e.success(n.openid):void wx.request({url:this.apiPath+"/v1/behavior_traces/get_openid",method:"GET",data:{jscode:n.jscode,appid:t.appId},success:function(t){if(1e3!==t.data.code)return error("openid获取失败",t),void e.fail(t);n.openid=t.data.openid;try{wx.setStorageSync("openid",n.openid)}catch(r){}e.success(n.openid),log("openid="+n.openid)},fail:function(t){error("getOpenId",t),e.fail(t)}})},getAuthParams:function(e){e=e||{};var t,n=this.props,r=+new Date,a=+new Date,o=e.openid,i=["nonce="+r,"timestamp="+a,"web_token="+o,n.companyToken].join("&");return n.debug&&log(i),t=sha1(i).toUpperCase(),{nonce:r,timestamp:a,web_token:o,signature:t}},getTraceConfig:function(e){e=e||{};var t=this.props,n=e.type,r=e.data,a=Object.assign({appid:t.appId,sdk_version:sdkVersion},this.getAuthParams(e));switch(n){case"product":return Object.assign(a,{behavior_trace:{type:n,data:r}}),{url:this.apiPath+"/v1/behavior_traces",data:a,validOpen:function(){return!!e.behavior_trace||(error("未开通商品浏览轨迹",e),!1)}};case"order":return Object.assign(a,{order:r}),{url:this.apiPath+"/v1/customer_orders",data:a,validOpen:function(){return!!e.customer_order||(error("未开通订单事件",e),!1)}};default:return null}},validTraceParams:function(e,t){var n=[],r="不能为空";if(!t)return error("data"+r),!1;switch(e){case"product":!t.name&&n.push("商品名称:"+r);break;case"order":!t.order_no&&n.push("订单编号:"+r),!t.price&&n.push("订单金额:"+r);break;default:n.push("type参数错误")}return!n.length||(error(n.join("、"),cfg),!1)},trace:function(e,t){var n,r=this,a=this.state;if(this.validTraceParams(e,t))return a.jscode?void this.getInitData({success:function(a){r.getOpenId({success:function(o){n=r.getTraceConfig(Object.assign({type:e,data:t,openid:o},a.data)),n.validOpen&&!n.validOpen()||wx.request({url:n.url,method:n.method||"POST",data:n.data,success:n.success||function(e){1e3!==e.data.code&&error(e.data.code_message,e)},fail:n.fail})}})}}):(a.lazyTraces=a.lazyTraces||[],void a.lazyTraces.push({type:e,data:t}))}}),Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]={init:function(e){sdkInstance=new UdeskSDK(e)},trace:function(e,t){if(sdkInstance)return sdkInstance.trace(e,t)}};